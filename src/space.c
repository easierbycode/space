#include "space.h"

static const unsigned char output[36][36] = { { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 12, 13, 12, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 5, 12, 5, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 5, 12, 5, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 5, 3, 11, 3, 5, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 5, 6, 11, 6, 5, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 5, 6, 11, 6, 5, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 4, 3, 8, 11, 8, 3, 4, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 4, 3, 6, 12, 6, 3, 4, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 5, 6, 12, 4, 12, 6, 5, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 3, 6, 12, 3, 12, 6, 3, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 12, 12, 12, 14, 14, 2, 5, 3, 12, 5, 7, 5, 12, 3, 5, 2, 14, 14, 12, 12, 12, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 12, 11, 11, 10, 12, 14, 2, 5, 3, 12, 5, 7, 5, 12, 3, 5, 2, 14, 12, 10, 11, 11, 12, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 12, 10, 9, 12, 11, 13, 13, 2, 13, 12, 4, 6, 4, 12, 13, 2, 13, 13, 11, 12, 9, 10, 12, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 12, 11, 10, 12, 11, 13, 14, 14, 2, 13, 2, 3, 2, 13, 2, 14, 14, 13, 11, 12, 10, 11, 12, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 12, 12, 13, 12, 14, 14, 12, 11, 2, 12, 2, 12, 2, 11, 12, 14, 14, 12, 13, 12, 12, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 12, 9, 7, 9, 11, 14, 12, 13, 10, 5, 6, 7, 6, 5, 10, 13, 12, 14, 11, 9, 7, 9, 12, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 12, 11, 9, 10, 11, 12, 13, 13, 10, 5, 8, 7, 8, 5, 10, 13, 13, 12, 11, 10, 9, 11, 12, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 12, 11, 10, 11, 2, 11, 10, 9, 9, 5, 3, 7, 3, 5, 9, 9, 10, 11, 2, 11, 10, 11, 12, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 12, 11, 2, 3, 12, 11, 10, 10, 5, 6, 7, 6, 5, 10, 10, 11, 12, 5, 2, 11, 12, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 12, 2, 5, 3, 12, 11, 10, 9, 10, 5, 6, 5, 10, 9, 10, 11, 12, 3, 5, 2, 12, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 2, 2, 5, 3, 6, 12, 11, 9, 7, 9, 5, 3, 5, 9, 7, 9, 11, 12, 6, 3, 5, 2, 2, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 2, 5, 3, 4, 4, 2, 12, 11, 10, 7, 9, 11, 5, 11, 9, 7, 10, 11, 12, 2, 4, 4, 3, 5, 2, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 2, 3, 4, 8, 8, 2, 2, 12, 11, 10, 11, 11, 14, 11, 11, 10, 11, 12, 2, 2, 8, 8, 4, 3, 2, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 2, 2, 2, 2, 2, 14, 14, 12, 12, 11, 11, 12, 14, 12, 11, 11, 12, 12, 14, 14, 2, 2, 2, 2, 2, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 13, 4, 5, 2, 14, 14, 14, 2, 5, 4, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 2, 2, 4, 2, 14, 14, 14, 2, 4, 2, 2, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 }, { 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14 } };

static unsigned char rotated_ship[36][36];

static const unsigned char ship_palette[15][4] = { {0xFF, 0xFF, 0xFF, 0x00 }, { 0x89, 0x01, 0x1D, 0x00 }, { 0xFF, 0x94, 0x6A, 0x00 }, { 0xCC, 0x3E, 0x00, 0x00 }, { 0xD9, 0x67, 0x00, 0x00 }, { 0xFD, 0xCA, 0x31, 0x00 }, { 0xFF, 0xFA, 0xEA, 0x00 }, { 0x1C, 0x5B, 0xF0, 0x00 }, { 0xBE, 0xBE, 0xBE, 0x00 }, { 0x94, 0x94, 0x94, 0x00 }, { 0x6B, 0x6B, 0x6B, 0x00 }, { 0x40, 0x40, 0x40, 0x00 }, { 0x1F, 0x1F, 0x1F, 0x00 }, { 0xFF, 0xFF, 0xFF, 0xFF } };

//Updates player1 location
void p1Move(struct SpaceGlobals *mySpaceGlobals) {
	
	mySpaceGlobals->renderP1Flag = 1;
	
	// Handle analog stick movements
	Vec2D left = mySpaceGlobals->lstick;
	Vec2D right = mySpaceGlobals->rstick;

	// get the differences
	float xdif = left.x + right.x;
	float ydif = left.y + right.y;
	
		char output1[255];
		__os_snprintf(output1, 255, "%f", xdif);
		drawString(100, 100, output1);

	// accept x and y movement from either stick
	mySpaceGlobals->p1X += xdif * mySpaceGlobals->speed;
	mySpaceGlobals->p1Y -= ydif * mySpaceGlobals->speed;
	
	
	// Handle D-pad movements as well
	mySpaceGlobals->p1X += (mySpaceGlobals->button & BUTTON_RIGHT)? 1 : 0;
	mySpaceGlobals->p1X -= (mySpaceGlobals->button &  BUTTON_LEFT)? 1 : 0;
	mySpaceGlobals->p1Y += (mySpaceGlobals->button &  BUTTON_DOWN)? 1 : 0;
	mySpaceGlobals->p1Y -= (mySpaceGlobals->button &    BUTTON_UP)? 1 : 0;

};

void render(struct SpaceGlobals *mySpaceGlobals)
{
	int ii = 0;
	for (ii; ii < 2; ii++)
	{
		if (mySpaceGlobals->renderResetFlag)
		{
			renderReset(mySpaceGlobals);
		}

		if (mySpaceGlobals->renderP1Flag)
		{
			renderShip(mySpaceGlobals);
		}
		
		flipBuffers();
	}

	resetRenderFlags(mySpaceGlobals);

}

void resetRenderFlags(struct SpaceGlobals *mySpaceGlobals)
{
	mySpaceGlobals->renderResetFlag = 0;
	mySpaceGlobals->renderP1Flag = 0;

}

void renderShip(struct SpaceGlobals *mySpaceGlobals) 
{
	drawBitmap(mySpaceGlobals->p1X, mySpaceGlobals->p1Y, 36, 36, output, ship_palette);
}

//Reset the game
void reset(struct SpaceGlobals *mySpaceGlobals) {
	//Set global variables to default state
	mySpaceGlobals->p1X = mySpaceGlobals->p1X_default;
	mySpaceGlobals->p1Y = mySpaceGlobals->p1Y_default;
	
	mySpaceGlobals->direction = (mySpaceGlobals->count & 3);
	mySpaceGlobals->button = 0;

	//Set flag to render reset screen;
	mySpaceGlobals->renderResetFlag = 1;

};

void renderReset(struct SpaceGlobals *mySpaceGlobals)
{
	fillScreen(0,0,0,0);
	renderInitialPlayers(mySpaceGlobals);
}

//Draws the inital player paddles and ball.
void renderInitialPlayers(struct SpaceGlobals *mySpaceGlobals) {
				renderShip(mySpaceGlobals);

};
